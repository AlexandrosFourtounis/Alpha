%{
    #include <stdio.h>
    int yyerror (char* yaccProvidedMessage);
    int alpha_yylex(void* yylval);
    extern int yylineno;
    extern char* yytext;
    extern FILE* yyin;
%}
%error-verbose
%start program

%token ID INTEGER KEYWORD_IF KEYWORD_THEN KEYWORD_ELSE KEYWORD_WHILE 
%token KEYWORD_FOR KEYWORD_FUNCTION KEYWORD_RETURN KEYWORD_BREAK KEYWORD_CONTINUE
%token KEYWORD_AND KEYWORD_NOT KEYWORD_OR KEYWORD_LOCAL KEYWORD_TRUE
%token KEYWORD_FALSE KEYWORD_NIL GREATER LESS EQUALS
%token GREATER_EQUAL LESS_EQUAL NOT_EQUAL INCREMENT DECREMENT 
%token STRING REAL
%token IDENTIFIER LEFTBRACE RIGHTBRACE LEFTBRACKET RIGHTBRACKET 
%token LEFTPARENTHESIS RIGHTPARENTHESIS COMMA SEMICOLON COLON 
%token DOT DOUBLEDOT DOUBLECOLON COMMENT

%right '='
%left ','
%left '+' '-'
%left '*' '/'
%nonassoc UMINUS
%left LEFTPARENTHESIS RIGHTPARENTHESIS

%%

program:            stmt
                    | program stmt

stmt:               expr ;
                    | ifstmt
                    | whilestmt
                    | forstmt
                    | returnstmt
                    | KEYWORD_BREAK ;
                    | KEYWORD_CONTINUE;
                    | block
                    | funcdef
                    | SEMICOLON

expr:               assignexpr
                    | expr op expr
                    | term

op:                 '+' | '-' | '*' | '/' | '%' | GREATER | GREATER_EQUAL | LESS | LESS_EQUAL | EQUALS | NOT_EQUAL | KEYWORD_AND | KEYWORD_OR
term:               LEFTPARENTHESIS expr RIGHTPARENTHESIS
                    | '-' expr
                    | KEYWORD_NOT expr
                    | INCREMENT lvalue
                    | lvalue INCREMENT
                    | DECREMENT lvalue
                    | lvalue DECREMENT
                    | primary

assignexpr:         lvalue '=' expr

primary:            lvalue
                    | call
                    | objectdef
                    | LEFTPARENTHESIS funcdef RIGHTPARENTHESIS
                    | const

lvalue:             IDENTIFIER
                    | KEYWORD_LOCAL IDENTIFIER
                    | DOUBLECOLON IDENTIFIER
                    | member

member:             lvalue DOT IDENTIFIER
                    | lvalue LEFTBRACKET expr RIGHTBRACKET
                    | call DOT IDENTIFIER
                    | call LEFTBRACKET expr RIGHTBRACKET

call:               call LEFTPARENTHESIS elist RIGHTPARENTHESIS
                    | lvalue callsuffix
                    | LEFTPARENTHESIS funcdef RIGHTPARENTHESIS LEFTPARENTHESIS elist RIGHTPARENTHESIS

callsuffix:         normcall
                    | methodcall

normcall:           LEFTPARENTHESIS elist RIGHTPARENTHESIS

methodcall:         DOUBLECOLON IDENTIFIER LEFTPARENTHESIS elist RIGHTPARENTHESIS // equivalent to lvalue.id(lvalue, elist)

elist:              LEFTBRACKET expr LEFTBRACKET COMMA expr RIGHTBRACKET '*' RIGHTBRACKET

objectdef:          LEFTBRACKET LEFTBRACKET elist KEYWORD_OR indexed RIGHTBRACKET RIGHTBRACKET

indexed:            LEFTBRACKET indexedelem LEFTBRACKET COMMA indexedelem RIGHTBRACKET '*' RIGHTBRACKET

indexedelem:        LEFTBRACE expr COLON expr RIGHTBRACE

block:              LEFTBRACE LEFTBRACKET stmt'*' RIGHTBRACKET RIGHTBRACE

funcdef:            KEYWORD_FUNCTION LEFTBRACKET IDENTIFIER RIGHTBRACKET LEFTPARENTHESIS idlist RIGHTPARENTHESIS block

const:              INTEGER | STRING | KEYWORD_NIL | KEYWORD_TRUE | KEYWORD_FALSE

idlist:             LEFTBRACKET IDENTIFIER LEFTBRACKET COMMA IDENTIFIER RIGHTBRACKET '*' RIGHTBRACKET

ifstmt:             KEYWORD_IF LEFTPARENTHESIS expr RIGHTPARENTHESIS stmt LEFTBRACKET KEYWORD_ELSE stmt RIGHTBRACKET

whilestmt:          KEYWORD_WHILE LEFTPARENTHESIS expr RIGHTPARENTHESIS stmt

forstmt:            KEYWORD_FOR LEFTPARENTHESIS elist SEMICOLON expr SEMICOLON elist RIGHTPARENTHESIS stmt

returnstmt:         KEYWORD_RETURN LEFTBRACKET expr RIGHTBRACKET SEMICOLON

%%
int yyerror (char* yaccProvidedMessage) {
    fprintf(stderr, "%s: at line %d, before token: %s\n",yaccProvidedMessage,yylineno,yytext);
    fprintf(stderr,"INPUT NOT VALID\n");
    return 1;
}

//**************************************************************

int main(int argc,char **argv){
    if(argc > 1){
        if(!(yyin = fopen(argv[1],"r"))){
            fprintf(stderr,"Cannot open file\n");
            return 1;
        }
    }else{
        yyin = stdin;
    }
    yyparse();
    return 0;
}